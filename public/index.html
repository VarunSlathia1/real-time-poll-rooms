<!DOCTYPE html>
<html>
<head>
  <title>Real-Time Poll Rooms</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Create Poll</h1>

  <input id="question" placeholder="Enter question" />
  <br><br>
  <input class="option" placeholder="Option 1" />
  <br><br>
  <input class="option" placeholder="Option 2" />
  <br><br>

  <button onclick="createPoll()">Create Poll</button>

  <hr>

  <div id="pollSection" style="display:none;">
    <h2 id="pollQuestion"></h2>
    <div id="options"></div>
  </div>

<script>
const socket = io();

async function createPoll() {
  const question = document.getElementById("question").value;
  const options = Array.from(document.getElementsByClassName("option"))
                      .map(o => o.value);

  const res = await fetch("/api/polls", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ question, options })
  });

  const data = await res.json();
  loadPoll(data.pollId);
}

async function loadPoll(pollId) {
  const res = await fetch(`/api/polls/${pollId}`);
  const poll = await res.json();

  document.getElementById("pollSection").style.display = "block";
  document.getElementById("pollQuestion").innerText = poll.question;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  poll.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.innerText = `${opt.text} (${opt.votes})`;
    btn.onclick = () => vote(poll.id, opt.id);
    optionsDiv.appendChild(btn);
    optionsDiv.appendChild(document.createElement("br"));
  });

  socket.emit("subscribe", poll.id);
}

function vote(pollId, optionId) {
  socket.emit("vote", {
    pollId,
    optionId,
    clientIP: "anonymous",
    deviceFingerprint: navigator.userAgent
  });
}

socket.on("poll:update", data => {
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  data.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.innerText = `${opt.text} (${opt.votes})`;
    optionsDiv.appendChild(btn);
    optionsDiv.appendChild(document.createElement("br"));
  });
});
</script>
</body>
</html>
